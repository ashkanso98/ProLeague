@model ProLeague.Domain.Entities.News
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using ProLeague.Domain.Entities
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = Model.Title;
    // Filter for approved comments right at the start
    var approvedComments = Model.Comments.Where(c => c.Status == CommentStatus.Approved).OrderByDescending(c => c.CreatedDate);
}

<style>
    /* Custom styles for the article page */
    .news-content {
        line-height: 1.8;
        font-size: 1.1rem;
        white-space: pre-wrap; /* This is the magic line that respects line breaks */
    }

    .comment-card {
        border: none;
        border-bottom: 1px solid #eee;
    }

        .comment-card:last-child {
            border-bottom: none;
        }

    .comment-avatar {
        font-size: 2.5rem;
        color: #adb5bd;
    }
</style>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <article>
                <header class="mb-4">
                    <h1 class="fw-bolder mb-1 display-5">@Model.Title</h1>
                    <div class="text-muted fst-italic mb-2">
                        منتشر شده در تاریخ @Model.PublishedDate.ToString("yyyy/MM/dd")
                    </div>
                </header>

                @if (!string.IsNullOrEmpty(Model.MainImagePath))
                {
                    <figure class="mb-4">
                        <img class="img-fluid rounded" src="@Model.MainImagePath" alt="@Model.Title" />
                    </figure>
                }

                <section class="mb-5 news-content">
                    @Model.Content
                </section>
            </article>

            <section class="mb-5">
                <div class="card bg-light">
                    <div class="card-body">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <form asp-action="AddComment" method="post" class="mb-4">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="newsId" value="@Model.Id" />
                                <textarea class="form-control" name="content" rows="3" placeholder="نظر خود را بنویسید..."></textarea>
                                <button class="btn btn-primary mt-2" type="submit">ارسال نظر</button>
                            </form>
                        }
                        else
                        {
                            <p class="text-center">
                                <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Context.Request.Path">برای ثبت نظر وارد شوید</a>
                            </p>
                        }

                        @if (approvedComments.Any())
                        {
                            foreach (var comment in approvedComments)
                            {
                                <div class="d-flex mb-4">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="fas fa-user-circle comment-avatar"></i>
                                    </div>
                                    <div class="w-100">
                                        <div class="fw-bold">@comment.User.UserName</div>
                                        @comment.Content
                                        <div class="text-muted" style="font-size: 0.8rem;">@comment.CreatedDate.ToString("g")</div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-center text-muted">هنوز نظری برای این خبر ثبت نشده است.</p>
                        }
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>